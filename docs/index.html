<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Tutor - TinyLlama + LoRA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="glow_round_favicon.png">
  <style>
    /* Theme variables */
    :root {
      --bg-color: #f3f4f6;
      --text-color: #111827;
      --panel-bg: #ffffff;
      --panel-border: #e5e7eb;
      --subtle-text: #6b7280;
      --badge-bg: #f9fafb;
      --badge-border: #d1d5db;
      --badge-text: #4b5563;
      --button-bg: #111827;
      --button-text: #f9fafb;
      --textarea-bg: #ffffff;
      --shadow-color: rgba(15, 23, 42, 0.10);
      --status-online-bg: #ecfdf3;
      --status-online-border: #bbf7d0;
      --status-online-text: #166534;
      --status-offline-bg: #fef2f2;
      --status-offline-border: #fecaca;
      --status-offline-text: #991b1b;
    }

    body.dark {
      --bg-color: #020617;
      --text-color: #e5e7eb;
      --panel-bg: #020617;
      --panel-border: #1f2937;
      --subtle-text: #9ca3af;
      --badge-bg: #020617;
      --badge-border: #334155;
      --badge-text: #e5e7eb;
      --button-bg: #e5e7eb;
      --button-text: #020617;
      --textarea-bg: #020617;
      --shadow-color: rgba(15, 23, 42, 0.60);
      --status-online-bg: #022c22;
      --status-online-border: #064e3b;
      --status-online-text: #6ee7b7;
      --status-offline-bg: #450a0a;
      --status-offline-border: #7f1d1d;
      --status-offline-text: #fecaca;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 16px;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .app {
      max-width: 960px;
      width: 100%;
      background: var(--panel-bg);
      border-radius: 16px;
      box-shadow: 0 18px 40px var(--shadow-color);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      border: 1px solid var(--panel-border);
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      border-bottom: 1px solid var(--panel-border);
      padding-bottom: 12px;
    }

    .title-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0;
      color: var(--text-color);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--subtle-text);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--badge-border);
      background: var(--badge-bg);
      color: var(--badge-text);
      white-space: nowrap;
    }

    .status {
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .status-online {
      color: var(--status-online-text);
      background: var(--status-online-bg);
      border-color: var(--status-online-border);
    }

    .status-offline {
      color: var(--status-offline-text);
      background: var(--status-offline-bg);
      border-color: var(--status-offline-border);
    }

    /* Top-left description on the page (desktop) */
    .page-description {
      position: fixed;
      top: 12px;
      left: 16px;
      max-width: 440px;
      font-size: 0.85rem;
      color: var(--subtle-text);
      line-height: 1.4;
      z-index: 10;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .toggle-group {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--panel-border);
      overflow: hidden;
      background: var(--badge-bg);
    }

    .toggle-group button {
      border: none;
      padding: 6px 12px;
      font-size: 0.85rem;
      background: transparent;
      cursor: pointer;
      color: var(--subtle-text);
    }

    .toggle-group button.active {
      background: var(--button-bg);
      color: var(--button-text);
    }

    label {
      font-size: 0.85rem;
      color: var(--subtle-text);
      font-weight: 500;
      display: block;
      margin-bottom: 4px;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      max-height: 260px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      font: inherit;
      line-height: 1.4;
      background: var(--textarea-bg);
      color: var(--text-color);
    }

    textarea::placeholder { color: var(--subtle-text); }

    textarea:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.4);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    button.primary {
      border-radius: 999px;
      border: none;
      padding: 8px 20px;
      font-size: 0.9rem;
      font-weight: 500;
      background: var(--button-bg);
      color: var(--button-text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.primary:disabled {
      opacity: 0.65;
      cursor: default;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--subtle-text);
    }

    .output {
      border-radius: 12px;
      border: 1px solid var(--panel-border);
      background: var(--badge-bg);
      padding: 12px 14px;
      max-height: 340px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }

    .output-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .output-meta {
      font-size: 0.8rem;
      color: var(--subtle-text);
    }

    .output-body {
      font-size: 0.9rem;
      color: var(--text-color);
      white-space: pre-wrap;
    }

    .error {
      font-size: 0.8rem;
      color: #fecaca;
      background: #450a0a;
      border: 1px solid #7f1d1d;
      border-radius: 8px;
      padding: 6px 8px;
      margin-top: 4px;
    }

    .theme-toggle {
      font-size: 0.8rem;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--panel-border);
      background: transparent;
      color: var(--subtle-text);
      cursor: pointer;
      white-space: nowrap;
    }

    /* Bottom-right page footer */
    .page-footer {
      position: fixed;
      right: 16px;
      bottom: 8px;
      font-size: 0.75rem;
      color: var(--subtle-text);
      z-index: 10;
    }

    /* ---------------- Mobile popup (mobile only) ---------------- */
    .intro-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.82);
      display: none;

      /* center the modal */
      align-items: center;
      justify-content: center;

      z-index: 9999;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }

    .intro-modal {
      width: 100%;
      max-width: 720px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      box-shadow: 0 18px 40px var(--shadow-color);

      display: flex;
      flex-direction: column;

      /* Fallback */
      max-height: calc(100vh - 24px);
      /* Mobile browsers: dynamic viewport height so buttons don't fall off-screen */
      max-height: calc(100dvh - 24px);

      overflow: hidden;
    }

    .intro-header {
      padding: 14px 16px 10px 16px;
      border-bottom: 1px solid var(--panel-border);
    }

    .intro-title {
      margin: 0;
      font-size: 1rem;
      color: var(--text-color);
    }

    .intro-content {
      padding: 12px 16px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;

      color: var(--subtle-text);
      font-size: 0.9rem;
      line-height: 1.5;

      /* ensure the content area takes remaining height so actions stay visible */
      flex: 1 1 auto;
    }

    .intro-content strong { color: var(--text-color); }

    .intro-actions {
      padding: 12px 16px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      border-top: 1px solid var(--panel-border);
      background: var(--panel-bg);

      /* keep it pinned inside the modal even while content scrolls */
      flex: 0 0 auto;
    }

    .intro-actions button.primary {
      width: 100%;
      justify-content: center;
      padding: 10px 18px;
    }

    /* ---------------- Mobile layout fixes ---------------- */
    @media (max-width: 900px) {
      body {
        padding: 14px 12px;
        padding-bottom: 44px; /* keep content clear of fixed footer */
      }

      .app {
        padding: 16px;
        gap: 18px;
      }

      /* Hide the left-side description on mobile */
      .page-description {
        display: none;
      }

      /* Stack title area cleanly */
      .title-row {
        flex-direction: column;
        align-items: flex-start;
      }

      /* WRAP these on mobile (no cutoff) */
      .badge-row {
        width: 100%;
        flex-wrap: wrap;
        gap: 8px;
      }

      .badge,
      .status,
      .theme-toggle {
        white-space: normal; /* allow wrapping on mobile only */
      }

      .actions {
        flex-direction: column;
        align-items: stretch;
      }

      .actions button.primary {
        width: 100%;
        justify-content: center;
      }

      textarea {
        min-height: 140px;
      }

      /* Footer stays bottom-right on mobile too */
      .page-footer {
        position: fixed;
        right: 16px;
        bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Top-left description (desktop only) -->
  <div class="page-description" id="page-description">
    <strong>Note:</strong> The backend is hosted in an Azure Container App with low idle replicas,
    so it may take 5-30 seconds to spool up after periods of inactivity.

    <br><br>

    This demo showcases the difference between the unmodified TinyLlama-1.1B model and a custom
    LoRA-finetuned variant designed specifically for tutoring. The base model shows how a small LLM
    behaves with no guidance ‚Äî answers may drift, vary in quality, or be overly long. The fine-tuned
    tutor model adds structure, clarity, and a consistent teaching style aimed at beginners.

    <br><br>

    Because this is a 1.1B-parameter model, even with careful prompting and fine-tuning it can still behave
    like a ‚Äútiny‚Äù model: occasional inaccuracies, repetition, or uneven depth are expected. This demo is meant
    to show how much LoRA can improve consistency, not to claim perfect results.

    <br><br>

    Everything here represents <strong>Phase 1</strong> of the project: a minimal, end-to-end AI tutor
    running inside a single Docker container deployed to Azure Container Apps using a quantized GGUF
    build for efficient CPU inference.

    <br><br>

    <strong>Coming in Phase 2:</strong> A more advanced LangGraph-powered tutoring pipeline with
    multi-step reasoning, Retrieval-Augmented Generation (RAG) using curated course materials, a
    feedback-driven refinement loop, and expanded evaluation tools. The goal is a more interactive,
    context-aware tutoring system that goes beyond single-shot answers and supports real learning
    progression.
  </div>

  <!-- Mobile one-time-per-visit popup -->
  <div class="intro-overlay" id="intro-overlay" aria-hidden="true">
    <div class="intro-modal" role="dialog" aria-modal="true" aria-labelledby="intro-title">
      <div class="intro-header">
        <h2 class="intro-title" id="intro-title">Project Overview</h2>
      </div>
      <div class="intro-content" id="intro-content"></div>
      <div class="intro-actions">
        <button class="primary" type="button" id="intro-continue">Continue</button>
      </div>
    </div>
  </div>

  <div class="app">
    <header class="header">
      <div class="title-row">
        <div>
          <h1>AI Tutor ‚Äì TinyLlama + LoRA</h1>
          <div class="subtitle">Compare base TinyLlama vs fine-tuned model.</div>
        </div>
        <div class="badge-row">
          <span class="badge">Backend: Azure Container Apps</span>
          <span class="badge">Model: TinyLlama-1.1B (GGUF)</span>
          <span class="badge">Adapter: LoRA (tutor style)</span>
          <span id="status-indicator" class="status status-offline">Checking backend...</span>
          <button id="theme-toggle" class="theme-toggle">üåô Dark</button>
        </div>
      </div>
    </header>

    <section class="controls">
      <div class="row">
        <div>
          <label>Model mode</label>
          <div class="toggle-group" id="mode-toggle">
            <button type="button" data-mode="base" class="active">Base model</button>
            <button type="button" data-mode="finetuned">Fine-tuned tutor</button>
          </div>
        </div>
      </div>

      <div>
        <label for="question-input">Ask a programming question</label>
        <textarea id="question-input" placeholder="Example: Explain what a variable is and show a short Python example."></textarea>
      </div>

      <div class="actions">
        <button id="ask-button" class="primary">
          <span id="ask-button-label">Ask the tutor</span>
        </button>
        <div class="hint">
          Tip: Press Enter to send. Try the same question with both modes to see the difference.
        </div>
      </div>
      <div id="error-box" class="error" style="display: none;"></div>
    </section>

    <section class="output" id="output-panel" style="display: none;">
      <div class="output-header">
        <div class="output-title">Tutor answer</div>
        <div class="output-meta" id="output-meta"></div>
      </div>
      <div class="output-body" id="output-body"></div>
    </section>
  </div>

  <!-- Bottom-right footer -->
  <div class="page-footer">
    Created by Eric Holt
  </div>

  <script>
    // Backend URL (Azure Container Apps)
    const API_BASE = "https://tutor-backend.gentlehill-a7c01db9.germanywestcentral.azurecontainerapps.io";

    const statusIndicator = document.getElementById("status-indicator");
    const modeToggle = document.getElementById("mode-toggle");
    const askButton = document.getElementById("ask-button");
    const askButtonLabel = document.getElementById("ask-button-label");
    const questionInput = document.getElementById("question-input");
    const errorBox = document.getElementById("error-box");
    const outputPanel = document.getElementById("output-panel");
    const outputMeta = document.getElementById("output-meta");
    const outputBody = document.getElementById("output-body");
    const themeToggle = document.getElementById("theme-toggle");

    const introOverlay = document.getElementById("intro-overlay");
    const introContent = document.getElementById("intro-content");
    const introContinue = document.getElementById("intro-continue");
    const pageDescription = document.getElementById("page-description");

    let currentMode = "base";

    function isMobileLayout() {
      return window.matchMedia("(max-width: 900px)").matches;
    }

    // MOBILE popup: show once per visit/tab (sessionStorage), not on desktop
    (function initMobileIntro() {
      if (!isMobileLayout()) return;

      const seenThisSession = sessionStorage.getItem("phase1_notice_seen_session_v1");
      if (seenThisSession === "true") return;

      introContent.innerHTML = pageDescription.innerHTML;

      introOverlay.style.display = "flex";
      introOverlay.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      introContinue.addEventListener("click", () => {
        sessionStorage.setItem("phase1_notice_seen_session_v1", "true");
        introOverlay.style.display = "none";
        introOverlay.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      });
    })();

    // THEME TOGGLE (Dark default)
    (function initTheme() {
      const saved = localStorage.getItem("theme");

      if (saved === "light") {
        document.body.classList.remove("dark");
        themeToggle.textContent = "üåô Dark";
      } else {
        document.body.classList.add("dark");
        themeToggle.textContent = "‚òÄÔ∏è Light";
      }
    })();

    themeToggle.addEventListener("click", () => {
      const isDark = document.body.classList.toggle("dark");

      if (isDark) {
        themeToggle.textContent = "‚òÄÔ∏è Light";
        localStorage.setItem("theme", "dark");
      } else {
        themeToggle.textContent = "üåô Dark";
        localStorage.setItem("theme", "light");
      }
    });

    async function checkHealth() {
      try {
        const res = await fetch(API_BASE + "/health", { method: "GET" });
        if (!res.ok) {
          throw new Error("Health check failed");
        }
        await res.json().catch(() => ({}));
        statusIndicator.textContent = "Backend online";
        statusIndicator.classList.remove("status-offline");
        statusIndicator.classList.add("status-online");
      } catch (err) {
        statusIndicator.textContent = "Backend offline";
        statusIndicator.classList.remove("status-online");
        statusIndicator.classList.add("status-offline");
      }
    }

    // Mode toggle
    modeToggle.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-mode]");
      if (!btn) return;
      const mode = btn.getAttribute("data-mode");

      currentMode = mode;

      for (const child of modeToggle.querySelectorAll("button")) {
        child.classList.toggle("active", child === btn);
      }
    });

    function setLoading(isLoading) {
      askButton.disabled = isLoading;
      askButtonLabel.textContent = isLoading ? "Thinking..." : "Ask the tutor";
    }

    function showError(message) {
      errorBox.textContent = message;
      errorBox.style.display = "block";
    }

    function clearError() {
      errorBox.textContent = "";
      errorBox.style.display = "none";
    }

    async function callTutor() {
      clearError();
      outputPanel.style.display = "none";

      const question = questionInput.value.trim();
      if (!question) {
        showError("Please enter a question first.");
        return;
      }

      const useFinetuned = currentMode === "finetuned";

      const payload = {
        question,
        use_finetuned: useFinetuned,
        use_rag: false
      };

      setLoading(true);

      try {
        const res = await fetch(API_BASE + "/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("Request failed with status " + res.status);
        }

        const data = await res.json();

        const modelType = data.model_type || (useFinetuned ? "finetuned" : "base");
        const usedRag = data.used_rag ? "RAG: on" : "RAG: off";

        outputMeta.textContent = `Model: ${modelType} ¬∑ ${usedRag}`;
        outputBody.textContent = data.answer || "(No answer returned)";
        outputPanel.style.display = "flex";
      } catch (err) {
        console.error(err);
        showError("There was an error calling the tutor API. Please try again.");
      } finally {
        setLoading(false);
      }
    }

    askButton.addEventListener("click", () => {
      callTutor();
    });

    // Press Enter to submit (Shift+Enter for newline)
    questionInput.addEventListener("keydown", (e) => {
      if (
        e.key === "Enter" &&
        !e.shiftKey &&
        !e.altKey &&
        !e.ctrlKey &&
        !e.metaKey
      ) {
        e.preventDefault();
        callTutor();
      }
    });

    // Initial health check on page load
    checkHealth();
  </script>
</body>
</html>
