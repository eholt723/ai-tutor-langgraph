<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Tutor - TinyLlama + LoRA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="glow_round_favicon.png">
  <style>
    /* Theme variables */
    :root {
      --bg-color: #f3f4f6;
      --text-color: #111827;
      --panel-bg: #ffffff;
      --panel-border: #e5e7eb;
      --subtle-text: #6b7280;
      --badge-bg: #f9fafb;
      --badge-border: #d1d5db;
      --badge-text: #4b5563;
      --button-bg: #111827;
      --button-text: #f9fafb;
      --textarea-bg: #ffffff;
      --shadow-color: rgba(15, 23, 42, 0.10);
      --status-online-bg: #ecfdf3;
      --status-online-border: #bbf7d0;
      --status-online-text: #166534;
      --status-offline-bg: #fef2f2;
      --status-offline-border: #fecaca;
      --status-offline-text: #991b1b;
    }

    body.dark {
      --bg-color: #020617;
      --text-color: #e5e7eb;
      --panel-bg: #020617;
      --panel-border: #1f2937;
      --subtle-text: #9ca3af;
      --badge-bg: #020617;
      --badge-border: #334155;
      --badge-text: #e5e7eb;
      --button-bg: #e5e7eb;
      --button-text: #020617;
      --textarea-bg: #020617;
      --shadow-color: rgba(15, 23, 42, 0.60);
      --status-online-bg: #022c22;
      --status-online-border: #064e3b;
      --status-online-text: #6ee7b7;
      --status-offline-bg: #450a0a;
      --status-offline-border: #7f1d1d;
      --status-offline-text: #fecaca;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 16px;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .app {
      max-width: 960px;
      width: 100%;
      background: var(--panel-bg);
      border-radius: 16px;
      box-shadow: 0 18px 40px var(--shadow-color);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      border: 1px solid var(--panel-border);
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      border-bottom: 1px solid var(--panel-border);
      padding-bottom: 12px;
    }

    .title-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0;
      color: var(--text-color);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--subtle-text);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--badge-border);
      background: var(--badge-bg);
      color: var(--badge-text);
      white-space: nowrap;
    }

    .status {
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .status-online {
      color: var(--status-online-text);
      background: var(--status-online-bg);
      border-color: var(--status-online-border);
    }

    .status-offline {
      color: var(--status-offline-text);
      background: var(--status-offline-bg);
      border-color: var(--status-offline-border);
    }

    .description {
      font-size: 0.85rem;
      color: var(--subtle-text);
      margin-top: 8px;
      max-width: 640px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .toggle-group {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--panel-border);
      overflow: hidden;
      background: var(--badge-bg);
    }

    .toggle-group button {
      border: none;
      padding: 6px 12px;
      font-size: 0.85rem;
      background: transparent;
      cursor: pointer;
      color: var(--subtle-text);
    }

    .toggle-group button.active {
      background: var(--button-bg);
      color: var(--button-text);
    }

    label {
      font-size: 0.85rem;
      color: var(--subtle-text);
      font-weight: 500;
      display: block;
      margin-bottom: 4px;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      max-height: 260px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      font: inherit;
      line-height: 1.4;
      background: var(--textarea-bg);
      color: var(--text-color);
    }

    textarea::placeholder {
      color: var(--subtle-text);
    }

    textarea:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.4);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    button.primary {
      border-radius: 999px;
      border: none;
      padding: 8px 20px;
      font-size: 0.9rem;
      font-weight: 500;
      background: var(--button-bg);
      color: var(--button-text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.primary:disabled {
      opacity: 0.65;
      cursor: default;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--subtle-text);
    }

    .output {
      border-radius: 12px;
      border: 1px solid var(--panel-border);
      background: var(--badge-bg);
      padding: 12px 14px;
      max-height: 340px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }

    .output-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .output-meta {
      font-size: 0.8rem;
      color: var(--subtle-text);
    }

    .output-body {
      font-size: 0.9rem;
      color: var(--text-color);
      white-space: pre-wrap;
    }

    .error {
      font-size: 0.8rem;
      color: #fecaca;
      background: #450a0a;
      border: 1px solid #7f1d1d;
      border-radius: 8px;
      padding: 6px 8px;
      margin-top: 4px;
    }

    .theme-toggle {
      font-size: 0.8rem;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--panel-border);
      background: transparent;
      color: var(--subtle-text);
      cursor: pointer;
      white-space: nowrap;
    }

    .footer {
      margin-top: auto;
      font-size: 0.75rem;
      color: var(--subtle-text);
      text-align: right;
    }

    @media (max-width: 640px) {
      .app {
        padding: 16px;
      }
      .actions {
        flex-direction: column;
        align-items: stretch;
      }
      .actions button.primary {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="title-row">
        <div>
          <h1>AI Tutor â€“ TinyLlama + LoRA</h1>
          <div class="subtitle">Compare base TinyLlama vs your fine-tuned tutor model.</div>
        </div>
        <div class="badge-row">
          <span class="badge">Backend: Azure Container Apps</span>
          <span class="badge">Model: TinyLlama-1.1B (GGUF)</span>
          <span class="badge">Adapter: LoRA (tutor style)</span>
          <span id="status-indicator" class="status status-offline">Checking backend...</span>
          <button id="theme-toggle" class="theme-toggle">ðŸŒ™ Dark</button>
        </div>
      </div>
      <p class="description">
        This page lets you compare the raw TinyLlama-1.1B model with a fine-tuned LoRA tutor head.
        The model is running inside a Docker container on Azure Container Apps with low replica counts,
        so it may take a moment to spool up after periods of idle time. TinyLlama can be a little quirky,
        but the fine-tuned tutor should feel more structured and beginner-friendly.
      </p>
    </header>

    <section class="controls">
      <div class="row">
        <div>
          <label>Model mode</label>
          <div class="toggle-group" id="mode-toggle">
            <button type="button" data-mode="base" class="active">Base model</button>
            <button type="button" data-mode="finetuned">Fine-tuned tutor</button>
          </div>
        </div>
      </div>

      <div>
        <label for="question-input">Ask a programming question</label>
        <textarea id="question-input" placeholder="Example: Explain what a variable is and show a short Python example."></textarea>
      </div>

      <div class="actions">
        <button id="ask-button" class="primary">
          <span id="ask-button-label">Ask the tutor</span>
        </button>
        <div class="hint">
          Tip: Press Enter to send. Try the same question with both modes to see the difference.
        </div>
      </div>
      <div id="error-box" class="error" style="display: none;"></div>
    </section>

    <section class="output" id="output-panel" style="display: none;">
      <div class="output-header">
        <div class="output-title">Tutor answer</div>
        <div class="output-meta" id="output-meta"></div>
      </div>
      <div class="output-body" id="output-body"></div>
    </section>

    <footer class="footer">
      Created by Eric Holt
    </footer>
  </div>

  <script>
    // Backend URL (Azure Container Apps)
    const API_BASE = "https://tutor-backend.gentlehill-a7c01db9.germanywestcentral.azurecontainerapps.io";

    const statusIndicator = document.getElementById("status-indicator");
    const modeToggle = document.getElementById("mode-toggle");
    const askButton = document.getElementById("ask-button");
    const askButtonLabel = document.getElementById("ask-button-label");
    const questionInput = document.getElementById("question-input");
    const errorBox = document.getElementById("error-box");
    const outputPanel = document.getElementById("output-panel");
    const outputMeta = document.getElementById("output-meta");
    const outputBody = document.getElementById("output-body");
    const themeToggle = document.getElementById("theme-toggle");

    let currentMode = "base";

    // THEME TOGGLE (Dark default)
    (function initTheme() {
      const saved = localStorage.getItem("theme");

      if (saved === "light") {
        document.body.classList.remove("dark");
        themeToggle.textContent = "ðŸŒ™ Dark";
      } else {
        document.body.classList.add("dark");
        themeToggle.textContent = "â˜€ï¸ Light";
      }
    })();

    themeToggle.addEventListener("click", () => {
      const isDark = document.body.classList.toggle("dark");

      if (isDark) {
        themeToggle.textContent = "â˜€ï¸ Light";
        localStorage.setItem("theme", "dark");
      } else {
        themeToggle.textContent = "ðŸŒ™ Dark";
        localStorage.setItem("theme", "light");
      }
    });

    async function checkHealth() {
      try {
        const res = await fetch(API_BASE + "/health", { method: "GET" });
        if (!res.ok) {
          throw new Error("Health check failed");
        }
        await res.json().catch(() => ({}));
        statusIndicator.textContent = "Backend online";
        statusIndicator.classList.remove("status-offline");
        statusIndicator.classList.add("status-online");
      } catch (err) {
        statusIndicator.textContent = "Backend offline";
        statusIndicator.classList.remove("status-online");
        statusIndicator.classList.add("status-offline");
      }
    }

    // Mode toggle
    modeToggle.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-mode]");
      if (!btn) return;
      const mode = btn.getAttribute("data-mode");

      currentMode = mode;

      for (const child of modeToggle.querySelectorAll("button")) {
        child.classList.toggle("active", child === btn);
      }
    });

    function setLoading(isLoading) {
      askButton.disabled = isLoading;
      askButtonLabel.textContent = isLoading ? "Thinking..." : "Ask the tutor";
    }

    function showError(message) {
      errorBox.textContent = message;
      errorBox.style.display = "block";
    }

    function clearError() {
      errorBox.textContent = "";
      errorBox.style.display = "none";
    }

    async function callTutor() {
      clearError();
      outputPanel.style.display = "none";

      const question = questionInput.value.trim();
      if (!question) {
        showError("Please enter a question first.");
        return;
      }

      const useFinetuned = currentMode === "finetuned";

      const payload = {
        question,
        use_finetuned: useFinetuned,
        use_rag: false
      };

      setLoading(true);

      try {
        const res = await fetch(API_BASE + "/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("Request failed with status " + res.status);
        }

        const data = await res.json();

        const modelType = data.model_type || (useFinetuned ? "finetuned" : "base");
        const usedRag = data.used_rag ? "RAG: on" : "RAG: off";

        outputMeta.textContent = `Model: ${modelType} Â· ${usedRag}`;
        outputBody.textContent = data.answer || "(No answer returned)";
        outputPanel.style.display = "flex";
      } catch (err) {
        console.error(err);
        showError("There was an error calling the tutor API. Please try again.");
      } finally {
        setLoading(false);
      }
    }

    askButton.addEventListener("click", () => {
      callTutor();
    });

    // Press Enter to submit (Shift+Enter for newline)
    questionInput.addEventListener("keydown", (e) => {
      if (
        e.key === "Enter" &&
        !e.shiftKey &&
        !e.altKey &&
        !e.ctrlKey &&
        !e.metaKey
      ) {
        e.preventDefault();
        callTutor();
      }
    });

    // Initial health check on page load
    checkHealth();
  </script>
</body>
</html>
